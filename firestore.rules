rules_version = '2';
// Firestore security rules (RLS) for COPE
// Deploy with: firebase deploy --only firestore:rules
// Docs: https://firebase.google.com/docs/firestore/security/get-started
//
// Data model (from codebase):
// - users/{userId}: profile (walletAddress, xHandle, isPublic, etc.). Client: read own + public profiles (search by wallet/xHandle); write own only.
// - users/{userId}/pushTokens/{tokenId}: push registration. Client: read/write own only; API (Admin SDK) for broadcast.
// - notifications/{notificationId}: wallet alerts (userId, walletAddress, etc.). Webhook + client create; client read/update/delete own only.
// - watchedWallets/{walletAddress}: reverse index for webhook. Server-only (API).
// - prices/{docId}: SOL price cache for webhook. Server-only (API).

service cloud.firestore {
  match /databases/{database}/documents {

    // Users: read own profile or any profile that is "public" (isPublic missing or true). Write own only.
    // Client uses: getDoc(own), getDocs(where walletAddress/xHandle) for search; setDoc(own).
    match /users/{userId} {
      allow read: if request.auth != null
        && (request.auth.uid == userId
            || !('isPublic' in resource.data)
            || resource.data.isPublic == true);
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Notifications: read/update/delete only own (userId == auth.uid). Create: client may create with userId == auth.uid; webhook creates via Admin SDK.
    match /notifications/{notificationId} {
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // Push tokens: client read/write own subcollection only. Admin broadcast uses API (Admin SDK).
    match /users/{userId}/pushTokens/{tokenId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Watched wallets: server-only (watchlist API + webhook). No client access.
    match /watchedWallets/{walletAddress} {
      allow read, write: if false;
    }

    // Prices: server-only (webhook SOL/token price cache). No client access.
    match /prices/{docId} {
      allow read, write: if false;
    }
  }
}
